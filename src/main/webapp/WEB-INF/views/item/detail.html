<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

<head>
    <meta charset="UTF-8">
    <title th:text="${item.name} + ' - 상세정보'">상품 상세</title>
    <link rel="stylesheet" th:href="@{/resources/css/style.css}">
</head>

<body>
<div layout:fragment="content" class="container">

    <h1 th:text="${item.name}">상품명</h1>

    <div class="item-detail-box">
        <img th:src="@{${item.image}}" alt="상품 이미지" style="width:300px; height:auto;"/>
        <div class="item-info">
            <p><strong>설명:</strong> <span th:text="${item.description}"></span></p>
            <p><strong>가격:</strong> <span th:text="${item.price}"></span> 원</p>
            <p><strong>등급:</strong> <span th:text="${item.grade}"></span></p>
            <p><strong>제조국:</strong> <span th:text="${item.manufactureCountry}"></span></p>
            <p><strong>상태:</strong> <span th:text="${item.status}"></span></p>
            <p><strong>베스트셀러:</strong> <span th:text="${item.isBestSeller} ? 'Yes' : 'No'"></span></p>
        </div>
    </div>

    <form th:action="@{/cart/add}" method="post">
        <input type="hidden" name="itemId" th:value="${item.itemId}"/>

        <!-- 숨겨진 itemOptionId (JS로 설정됨) -->
        <input type="hidden" id="itemOptionId" name="itemOptionId"/>

        <!-- 색상 선택 -->
        <label for="colorSelect">색상:</label>
        <select id="colorSelect" required>
            <option disabled selected>색상을 선택하세요</option>
            <th:block th:each="color : ${colorOptions}">
                <option th:value="${color.colorOptionId}" th:text="${color.colorName}"></option>
            </th:block>
        </select>

        <!-- 사이즈 선택 -->
        <label for="sizeSelect">사이즈:</label>
        <select id="sizeSelect" required>
            <option disabled selected>사이즈를 선택하세요</option>
            <th:block th:each="size : ${sizeOptions}">
                <option th:value="${size.sizeOptionId}"
                        th:text="${size.sizeName + ' (' + size.quantity + '개 재고)'}">
                </option>
            </th:block>
        </select>

        <p id="inventoryInfo" style="margin-top: 10px; color: green;"></p>

        <label for="quantity">수량:</label>
        <input type="number" name="quantity" id="quantity" value="1" min="1" required/>

        <div class="action-buttons">
            <button type="submit" formaction="/cart/add">장바구니</button>
            <button type="submit" formaction="/order/create">주문하기</button>
        </div>
    </form>

    <form th:action="@{/item/delete/{id}(id=${item.itemId})}" method="post" style="margin-top: 20px;">
        <button type="submit">삭제</button>
    </form>

    <a th:href="@{/item}">목록으로</a>
</div>

<script th:inline="javascript">
    const options = /*[[${options}]]*/ [];
    const colorSelect = document.getElementById('colorSelect');
    const sizeSelect = document.getElementById('sizeSelect');
    const itemOptionIdInput = document.getElementById('itemOptionId');
    const inventoryInfo = document.getElementById('inventoryInfo');
    const quantityInput = document.getElementById('quantity');

    const cartBtn = document.querySelector('button[formaction="/cart/add"]');
    const orderBtn = document.querySelector('button[formaction="/order/create"]');

    function updateSelection() {
        const colorId = Number(colorSelect.value);
        const sizeId = Number(sizeSelect.value);

        const match = options.find(o =>
            o.colorOptionId === colorId && o.sizeOptionId === sizeId
        );

        if (match) {
            itemOptionIdInput.value = match.itemOptionId;
            inventoryInfo.textContent = `재고: ${match.quantity}개 / 추가금액: ${match.additionalPrice}원`;

            quantityInput.max = match.quantity;
            if (Number(quantityInput.value) > match.quantity) {
                quantityInput.value = match.quantity;
            }

            const isSoldOut = match.quantity === 0;
            cartBtn.disabled = isSoldOut;
            orderBtn.disabled = isSoldOut;

        } else {
            itemOptionIdInput.value = '';
            inventoryInfo.textContent = '해당 조합의 옵션이 없습니다.';
            quantityInput.removeAttribute('max');
            cartBtn.disabled = true;
            orderBtn.disabled = true;
        }
    }

    colorSelect.addEventListener('change', updateSelection);
    sizeSelect.addEventListener('change', updateSelection);
</script>
</body>
</html>
